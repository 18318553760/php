## 概述

记录下，工作中遇到的坑 ...

关于 PHP 浮点数运算，特别是金融行业、电子商务订单管理、数据报表等相关业务，利用浮点数进行加减乘除时，稍不留神运算结果就会出现偏差，轻则损失几十万，重则会有信誉损失，甚至吃上官司，我们一定要引起高度重视！

## 浮点数运算的“锅”

```
//加
$a = 0.1;
$b = 0.7;
$c = intval(($a + $b) * 10);
echo $c."<br>";
//输出：7

//减
$a = 100;
$b = 99.98;
$c = $a - $b;
echo $c."<br>";
//输出：0.019999999999996

//乘
$a = 0.58;
$b = 100;
$c = intval($a * $b);
echo $c."<br>";
//输出：57

//除
$a = 0.7;
$b = 0.1;
$c = intval($a / $b);
echo $c."<br>";
//输出：6
```

上面的结果，显然不是我们想要的！

PHP 官方手册解释如下：

> 浮点数的精度有限。尽管取决于系统，PHP 通常使用 IEEE 754 双精度格式，则由于取整而导致的最大相对误差为 1.11e-16。非基本数学运算可能会给出更大误差，并且要考虑到进行复合运算时的误差传递。永远不要相信浮点数结果精确到了最后一位，也永远不要比较两个浮点数是否相等。如果确实需要更高的精度，应该使用**任意精度数学函数** 或者 **gmp 函数**。

这里的关键在于，浮点数的小数用二进制的表示，过程如下：

- 将小数乘以2，取整数部分表示第一位；
- 将小数部分乘以2，取整数部分表示第二位；
- 再将小数部分乘以2，取整数部分表示第三位；
- ... 依次类推，直到小数部分为0；

例：0.58

- 0.58 * 2 = 1.16 ---> 1
- 0.16 * 2 = 0.32 ---> 0
- 0.32 * 2 = 0.64 ---> 0
- 0.64 * 2 = 1.28 ---> 1
- 0.28 * 2 = 0.56 ---> 0
- 0.56 * 2 = 1.12 ---> 1
- 0.12 * 2 = 0.24 ---> 0
- 0.24 * 2 = 0.48 ---> 0
- 0.48 * 2 = 0.96 ---> 0
- 0.96 * 2 = 1.92 ---> 1
- ...

我们会得到一个无限循环的二进制小数：

0.1001010001...

小数部分出现循环，有限的二进制位无法准确的表示一个小数，这也就是小数运算出现误差的原因。

接下来给大家介绍 **任意精度数学函数**。

## 任意精度数学函数

对于任意精度的数学，PHP 提供了支持用字符串表示的任意大小和精度的数字的二进制计算。

BCMath：BC 是 Binary Calculator 的缩写。

官方手册：http://php.net/manual/zh/book.bc.php

大家在使用前，请先确认是否已安装 bcmath。

```
//加
$a = 0.1;
$b = 0.7;
$c = intval(bcadd($a, $b, 1) * 10);
echo $c."<br>";
//输出：8

//减
$a = 100;
$b = 99.98;
$c = bcsub($a, $b, 2);
echo $c."<br>";
//输出：0.02

//乘
$a = 0.58;
$b = 100;
$c = intval(bcmul($a, $b));
echo $c."<br>";
//输出：58

//除
$a = 0.7;
$b = 0.1;
$c = intval(bcdiv($a, $b));
echo $c."<br>";
//输出：7
```

除了加减乘除，bcmath 还提供了以下方法：

- bccomp 比较两个任意精度的数字
- bcmod 对一个任意精度数字取模
- bcpow 任意精度数字的乘方
- bcpowmod 高精度数字乘方求模
- bcscale 设置所有bc数学函数的默认小数点保留位数
- bcsqrt 任意精度数字的二次方根

## 常用数值处理方案

#### 舍去法取整(向下取整)

```
echo floor(5.1);
//输出：5

echo floor(8.8);
//输出：8
```

#### 进一法取整(向上取整)

```
echo ceil(5.1);
//输出：6

echo ceil(8.8);
//输出：9
```

#### 普通四舍五入法

```
echo round(5.1);
//输出：5

echo round(8.8);
//输出：9

//保留两位小数并且进行四舍五入
echo round(5.123, 2);
//输出：5.12

echo round(8.888, 2);
//输出：8.89

//保留两位小数并且不进行四舍五入
echo substr(round(5.12345, 3), 0, -1);
//输出：5.12

echo substr(round(8.88888, 3), 0, -1);
//输出：8.88
```

#### 银行家舍入法

四舍六入五考虑，五后非空就进一，五后为空看奇偶，五前为偶应舍去，五前为奇要进一。

保留两位小数，例：

- 1.2849 = 1.28 -> 四舍
- 1.2866 = 1.29 -> 六入
- 1.2851 = 1.29 -> 五后非空就进一
- 1.2850 = 1.28 -> 五后为空看奇偶，五前为偶应舍去
- 1.2750 = 1.28 -> 五后为空看奇偶，五前为奇要进一

实现代码如下：

```
echo round(1.2849, 2, PHP_ROUND_HALF_EVEN);
//输出：1.28

echo round(1.2866, 2, PHP_ROUND_HALF_EVEN);
//输出：1.29

echo round(1.2851, 2, PHP_ROUND_HALF_EVEN);
//输出：1.29

echo round(1.2850, 2, PHP_ROUND_HALF_EVEN);
//输出：1.28

echo round(1.2750, 2, PHP_ROUND_HALF_EVEN);
//输出：1.28
```

更多 round 使用说明，请查阅官方手册：

http://php.net/manual/zh/function.round.php

#### 数值格式化(千位分组)

应用于金额的展示，比如我们经常会看的银行卡余额。

```
echo number_format('10000.98', 2, '.', ',');
//输出：10,000.98

echo number_format('340888999', 2, '.', ',');
//输出：340,888,999.00
```

## 扩展

#### MySQL 浮点型字段

在 MySQL 中，创建表字段时也有浮点数类型。

浮点数类型包括单精度浮点数（float）和双精度浮点数（double）。

**同理，不建议使用浮点数类型！！！**

浮点数存在误差，当我们使用精度敏感的数据时，应该使用定点数（decimal）进行存储。

## 小结

通过浮点数精度的问题，了解到浮点数的小数用二进制的表示。

分享了用 **PHP 任意精度数学函数**，来进行高精度运算。

同时分享了常用数值处理方案，比如舍去法、进一法、四舍五入法、银行家舍入法、数值格式化 等。

最后，通过 PHP 的 float 联想到 MySQL 的 float。

以后，在使用浮点数运算的时候，一定要慎之又慎，细节决定成败。